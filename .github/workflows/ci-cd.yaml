name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Получаем код
    - uses: actions/checkout@v3
    
    # 2. Отладка: проверяем секреты (ИСПРАВЛЕННЫЙ ВАРИАНТ)
    - name: Debug - Check secrets
      run: |
        echo "=== Debug: Checking secrets ==="
        if [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then
          echo "✓ DOCKER_USERNAME is set (length: ${{ length(secrets.DOCKER_USERNAME) }})"
        else
          echo "✗ DOCKER_USERNAME is NOT set"
        fi
        
        if [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
          echo "✓ DOCKER_PASSWORD is set (length: ${{ length(secrets.DOCKER_PASSWORD) }})"
        else
          echo "✗ DOCKER_PASSWORD is NOT set"
        fi
        
        if [ -n "${{ secrets.KUBECONFIG }}" ]; then
          echo "✓ KUBECONFIG is set"
        else
          echo "✗ KUBECONFIG is NOT set"
        fi
    
    # 3. Настраиваем Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    # 4. Логин в Docker Hub (ПРОСТОЙ И НАДЕЖНЫЙ ВАРИАНТ)
    - name: Log in to Docker Hub
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "Attempting Docker login for user: $DOCKER_USER"
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
        echo "Docker login completed"
    
    # 5. Сборка и пушим образ
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/todo-app:latest
    
    # 6. Настраиваем kubectl
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
    
    # 7. Деплой в Kubernetes
    - name: Deploy to Kubernetes
      env:
        KUBE_CONFIG: ${{ secrets.KUBECONFIG }}
      run: |
        # Создаем временный файл с конфигом
        echo "$KUBE_CONFIG" | base64 --decode > /tmp/kubeconfig
        export KUBECONFIG=/tmp/kubeconfig
        
        echo "=== Deploying to Kubernetes ==="
        kubectl cluster-info
        
        # Создаем namespace если нужно
        kubectl create namespace todo-app --dry-run=client -o yaml | kubectl apply -f -
        
        # Применяем манифесты
        if [ -d "k8s" ]; then
          kubectl apply -f k8s/
        else
          echo "ERROR: k8s directory not found!"
          echo "Current directory contents:"
          ls -la
          exit 1
        fi
        
        # Проверяем деплой
        echo "=== Deployment status ==="
        kubectl get pods,svc,deploy -n todo-app || kubectl get pods,svc,deploy

name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Получаем код
    - uses: actions/checkout@v3
    
    # 2. Отладка: проверяем секреты
    - name: Debug - Check if secrets exist
      run: |
        echo "Checking secrets..."
        if [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then
          echo "✓ DOCKER_USERNAME is SET"
        else
          echo "✗ DOCKER_USERNAME is NOT SET"
        fi
        
        if [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
          echo "✓ DOCKER_PASSWORD is SET"
        else
          echo "✗ DOCKER_PASSWORD is NOT SET"
        fi
    
    # 3. Настраиваем Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    # 4. Логин в Docker Hub (ИСПРАВЛЕННАЯ ВЕРСИЯ)
    - name: Log in to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
          -u "${{ secrets.DOCKER_USERNAME }}" \
          --password-stdin
    
    # 5. Сборка и пушим образ
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/todo-app:latest
          ${{ secrets.DOCKER_USERNAME }}/todo-app:${{ github.sha }}
    
    # 6. Настраиваем kubectl
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
    
    # 7. Деплой в Kubernetes
    - name: Deploy to Kubernetes
      run: |
        # Создаем временный файл с конфигом
        echo "${{ secrets.KUBECONFIG }}" | base64 --decode > /tmp/kubeconfig
        export KUBECONFIG=/tmp/kubeconfig
        
        # Проверяем подключение
        kubectl cluster-info
        
        # Применяем манифесты
        kubectl apply -f k8s/ --recursive
        
        # Проверяем деплой
        kubectl get pods
        kubectl get services
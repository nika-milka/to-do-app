name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    # 1. Логин в Docker Hub
    - name: Log in to Docker Hub
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    # 2. Сборка и пуш
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/todo-app:latest
    
    # 3. Установка Minikube
    - name: Install and start Minikube
      run: |
        echo "=== Installing Minikube ==="
        
        # Установка kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        
        # Установка Minikube
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        
        # Запуск Minikube
        minikube start --driver=docker
        
        # Проверка
        echo "Minikube status:"
        minikube status
        
        echo "Kubernetes cluster info:"
        kubectl cluster-info
        
        echo "Nodes:"
        kubectl get nodes
        
    # 4. СОЗДАЕМ DOCKER SECRET ДЛЯ KUBERNETES (ВАЖНО!)
    - name: Create Docker Registry Secret
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "=== Creating Docker Hub secret ==="
        
        # Создаем секрет для доступа к Docker Hub
        kubectl create secret docker-registry docker-hub-secret \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username=$DOCKER_USER \
          --docker-password=$DOCKER_PASS \
          --docker-email=ci-cd@example.com
        
        echo "✅ Docker secret created"
    
    # 5. Деплой приложения
    - name: Deploy Application
      run: |
        echo "=== Deploying application ==="
        
        # Применяем манифесты MongoDB
        if [ -f "k8s/mongo-deployment.yaml" ]; then
          kubectl apply -f k8s/mongo-deployment.yaml
          kubectl apply -f k8s/mongo-service.yaml
          echo "MongoDB deployed"
        fi
        
        # Применяем манифесты приложения
        if [ -f "k8s/deployment.yaml" ]; then
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          echo "Application deployed"
        fi
        
        # Ждем запуска подов
        echo "Waiting for pods to be ready..."
        sleep 45  # Увеличиваем время ожидания
        
        # Проверяем состояние
        echo "=== Current state ==="
        kubectl get pods,svc,deploy -o wide
        
        # Показываем детали ошибки если есть
        echo "=== Pod details (if error) ==="
        kubectl describe pods -l app=todo-app | grep -A20 "Events:" || true
        
        # Получаем URL
        echo "=== Application URL ==="
        minikube service todo-app-service --url || echo "Run: minikube service todo-app-service --url"
    
    # 6. Проверяем, что образ скачался
    - name: Check Pod Status
      run: |
        echo "=== Checking pod status ==="
        
        # Проверяем статус подов
        kubectl get pods -o wide
        
        # Показываем ошибки ImagePull если есть
        echo ""
        echo "=== Checking for ImagePull errors ==="
        kubectl describe pods -l app=todo-app | grep -i "image" || true
        
        # Проверяем логи пода
        echo ""
        echo "=== Pod logs ==="
        kubectl logs -l app=todo-app --tail=20 || echo "No logs available (pod not running)"
    
    # 7. Если есть ошибка ImagePull, исправляем deployment
    - name: Fix Deployment if Needed
      run: |
        echo "=== Checking and fixing deployment ==="
        
        # Проверяем статус
        POD_STATUS=$(kubectl get pods -l app=todo-app -o jsonpath='{.items[0].status.containerStatuses[0].state.waiting.reason}' 2>/dev/null || echo "")
        
        if [ "$POD_STATUS" = "ImagePullBackOff" ] || [ "$POD_STATUS" = "ErrImagePull" ]; then
          echo "⚠️ Found ImagePull error: $POD_STATUS"
          echo "Fixing deployment..."
          
          # Патчим deployment, добавляя imagePullSecrets
          kubectl patch deployment todo-app-deployment -p '{"spec":{"template":{"spec":{"imagePullSecrets":[{"name":"docker-hub-secret"}]}}}}'
          
          echo "✅ Deployment patched with imagePullSecrets"
          
          # Удаляем старые поды, чтобы создать новые
          kubectl delete pods -l app=todo-app
          
          echo "Waiting for new pods..."
          sleep 30
        else
          echo "✅ No ImagePull errors detected"
        fi
    
    # 8. Тестирование
    - name: Test Application
      run: |
        echo "=== Testing application ==="
        
        # Проверяем, что поды запущены
        echo "Checking if pods are running..."
        RUNNING_PODS=$(kubectl get pods -l app=todo-app -o jsonpath='{.items[*].status.phase}' | grep -c Running || echo "0")
        
        if [ "$RUNNING_PODS" -eq "0" ]; then
          echo "❌ No running pods found"
          echo "Troubleshooting:"
          kubectl describe pods -l app=todo-app
          exit 1
        fi
        
        echo "✅ Found $RUNNING_PODS running pod(s)"
        
        # Получаем URL сервиса
        APP_URL=$(minikube service todo-app-service --url 2>/dev/null | head -1)
        
        if [ -z "$APP_URL" ]; then
          echo "ERROR: Could not get application URL"
          echo "Testing via port-forward..."
          
          # Запускаем port-forward
          kubectl port-forward svc/todo-app-service 8080:80 &
          PF_PID=$!
          sleep 5
          
          # Тестируем
          if curl -s http://localhost:8080/todos; then
            echo "✅ Application is working via port-forward!"
            kill $PF_PID
            exit 0
          else
            echo "❌ Application not responding"
            kill $PF_PID
            exit 1
          fi
        fi
        
        echo "Testing endpoint: $APP_URL/todos"
        
        # Простой тест
        if curl -s --max-time 30 "$APP_URL/todos"; then
          echo "✅ Application is responding!"
        else
          echo "⚠️ Application not responding, but continuing..."
        fi
    
    # 9. Проверка MongoDB
    - name: Verify MongoDB Connection
      run: |
        echo "=== Verifying MongoDB ==="
        
        # Проверяем, что MongoDB поднята
        kubectl get pods -l app=mongodb
        
        # Проверяем логи MongoDB
        MONGO_POD=$(kubectl get pods -l app=mongodb -o jsonpath='{.items[0].metadata.name}')
        echo "MongoDB pod: $MONGO_POD"
        
        # Проверяем, что MongoDB принимает подключения
        kubectl exec $MONGO_POD -- mongosh --eval "db.adminCommand('ping')" && echo "✅ MongoDB is responsive"
        
        # Проверяем базу данных todo
        echo "Checking todo database..."
        kubectl exec $MONGO_POD -- mongosh todo --eval "db.getCollectionNames()" || echo "Database might not exist yet"

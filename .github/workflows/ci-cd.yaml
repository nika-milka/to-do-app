name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    # 1. Логин в Docker Hub
    - name: Log in to Docker Hub
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    # 2. Сборка и пуш
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/todo-app:latest
    
    # 3. Установка Minikube (вместо использования внешнего KUBECONFIG)
    - name: Install and start Minikube
      run: |
        echo "=== Installing Minikube ==="
        
        # Установка kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        
        # Установка Minikube
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        
        # Запуск Minikube
        minikube start --driver=docker
        
        # Проверка
        echo "Minikube status:"
        minikube status
        
        echo "Kubernetes cluster info:"
        kubectl cluster-info
        
        echo "Nodes:"
        kubectl get nodes
        
    # 4. Деплой приложения
    - name: Deploy Application
      run: |
        echo "=== Deploying application ==="
        
        # Применяем манифесты MongoDB
        if [ -f "k8s/mongo-deployment.yaml" ]; then
          kubectl apply -f k8s/mongo-deployment.yaml
          kubectl apply -f k8s/mongo-service.yaml
          echo "MongoDB deployed"
        fi
        
        # Применяем манифесты приложения
        if [ -f "k8s/deployment.yaml" ]; then
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          echo "Application deployed"
        fi
        
        # Ждем запуска подов
        echo "Waiting for pods to be ready..."
        sleep 30
        
        # Проверяем состояние
        echo "=== Current state ==="
        kubectl get pods,svc,deploy -o wide
        
        # Получаем URL
        echo "=== Application URL ==="
        minikube service todo-app-service --url || echo "Run: minikube service todo-app-service --url"
        
    # 5. Тестирование
    - name: Test Application
      run: |
        echo "=== Testing application ==="
        
        # Получаем URL сервиса
        APP_URL=$(minikube service todo-app-service --url 2>/dev/null | head -1)
        
        if [ -n "$APP_URL" ]; then
          echo "Testing endpoint: $APP_URL/todos"
          
          # Пробуем несколько раз
          for i in {1..5}; do
            echo "Attempt $i..."
            if curl -s "$APP_URL/todos"; then
              echo "✅ Application is responding!"
              break
            else
              echo "Waiting... ($i/5)"
              sleep 10
            fi
          done
        else
          echo "Could not get service URL"
          echo "Debug info:"
          kubectl describe service todo-app-service
        fi

name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    # 1. Логин в Docker Hub
    - name: Log in to Docker Hub
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    # 2. Сборка и пуш
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/todo-app:latest
    
    # 3. Установка Minikube
    - name: Install and start Minikube
      run: |
        echo "=== Installing Minikube ==="
        
        # Установка kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        
        # Установка Minikube
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        
        # Запуск Minikube
        minikube start --driver=docker
        
        # Проверка
        echo "Minikube status:"
        minikube status
        
        echo "Kubernetes cluster info:"
        kubectl cluster-info
        
        echo "Nodes:"
        kubectl get nodes
        
    # 4. СОЗДАЕМ DOCKER SECRET ДЛЯ KUBERNETES (ВАЖНО!)
    - name: Create Docker Registry Secret
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "=== Creating Docker Hub secret ==="
        
        # Создаем секрет для доступа к Docker Hub
        kubectl create secret docker-registry docker-hub-secret \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username=$DOCKER_USER \
          --docker-password=$DOCKER_PASS \
          --docker-email=ci-cd@example.com
        
        echo "✅ Docker secret created"
    
    # 5. Деплой приложения
    - name: Deploy Application
      run: |
        echo "=== Deploying application ==="
        
        # Применяем манифесты MongoDB
        if [ -f "k8s/mongo-deployment.yaml" ]; then
          kubectl apply -f k8s/mongo-deployment.yaml
          kubectl apply -f k8s/mongo-service.yaml
          echo "MongoDB deployed"
        fi
        
        # Применяем манифесты приложения
        if [ -f "k8s/deployment.yaml" ]; then
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          echo "Application deployed"
        fi
        
        # Ждем запуска подов
        echo "Waiting for pods to be ready..."
        sleep 45  # Увеличиваем время ожидания
        
        # Проверяем состояние
        echo "=== Current state ==="
        kubectl get pods,svc,deploy -o wide
        
        # Показываем детали ошибки если есть
        echo "=== Pod details (if error) ==="
        kubectl describe pods -l app=todo-app | grep -A20 "Events:" || true
        
        # Получаем URL
        echo "=== Application URL ==="
        minikube service todo-app-service --url || echo "Run: minikube service todo-app-service --url"
    
    # 6. Проверяем, что образ скачался
    - name: Check Pod Status
      run: |
        echo "=== Checking pod status ==="
        
        # Проверяем статус подов
        kubectl get pods -o wide
        
        # Показываем ошибки ImagePull если есть
        echo ""
        echo "=== Checking for ImagePull errors ==="
        kubectl describe pods -l app=todo-app | grep -i "image" || true
        
        # Проверяем логи пода
        echo ""
        echo "=== Pod logs ==="
        kubectl logs -l app=todo-app --tail=20 || echo "No logs available (pod not running)"
    
    # 7. Если есть ошибка ImagePull, исправляем deployment
    - name: Fix Deployment if Needed
      run: |
        echo "=== Checking and fixing deployment ==="
        
        # Проверяем статус
        POD_STATUS=$(kubectl get pods -l app=todo-app -o jsonpath='{.items[0].status.containerStatuses[0].state.waiting.reason}' 2>/dev/null || echo "")
        
        if [ "$POD_STATUS" = "ImagePullBackOff" ] || [ "$POD_STATUS" = "ErrImagePull" ]; then
          echo "⚠️ Found ImagePull error: $POD_STATUS"
          echo "Fixing deployment..."
          
          # Патчим deployment, добавляя imagePullSecrets
          kubectl patch deployment todo-app-deployment -p '{"spec":{"template":{"spec":{"imagePullSecrets":[{"name":"docker-hub-secret"}]}}}}'
          
          echo "✅ Deployment patched with imagePullSecrets"
          
          # Удаляем старые поды, чтобы создать новые
          kubectl delete pods -l app=todo-app
          
          echo "Waiting for new pods..."
          sleep 30
        else
          echo "✅ No ImagePull errors detected"
        fi
    
    # 8. Тестирование
    - name: Test Application
      run: |
        echo "=== Testing application ==="
        
        # Проверяем, что поды запущены
        echo "Checking if pods are running..."
        RUNNING_PODS=$(kubectl get pods -l app=todo-app -o jsonpath='{.items[*].status.phase}' | grep -c Running || echo "0")
        
        if [ "$RUNNING_PODS" -eq "0" ]; then
          echo "❌ No running pods found"
          echo "Troubleshooting:"
          kubectl describe pods -l app=todo-app
          exit 1
        fi
        
        echo "✅ Found $RUNNING_PODS running pod(s)"
        
        # Получаем URL сервиса
        APP_URL=$(minikube service todo-app-service --url 2>/dev/null | head -1)
        
        if [ -z "$APP_URL" ]; then
          echo "ERROR: Could not get application URL"
          echo "Testing via port-forward..."
          
          # Запускаем port-forward
          kubectl port-forward svc/todo-app-service 8080:80 &
          PF_PID=$!
          sleep 5
          
          # Тестируем
          if curl -s http://localhost:8080/todos; then
            echo "✅ Application is working via port-forward!"
            kill $PF_PID
            exit 0
          else
            echo "❌ Application not responding"
            kill $PF_PID
            exit 1
          fi
        fi
        
        echo "Testing endpoint: $APP_URL/todos"
        
        # Простой тест
        if curl -s --max-time 30 "$APP_URL/todos"; then
          echo "✅ Application is responding!"
        else
          echo "⚠️ Application not responding, but continuing..."
        fi
    
    # 9. Проверка MongoDB
    - name: Verify MongoDB Connection
      run: |
        echo "=== Verifying MongoDB ==="
        
        # Проверяем, что MongoDB поднята
        kubectl get pods -l app=mongodb
        
        # Проверяем логи MongoDB
        MONGO_POD=$(kubectl get pods -l app=mongodb -o jsonpath='{.items[0].metadata.name}')
        echo "MongoDB pod: $MONGO_POD"
        
        # Проверяем, что MongoDB принимает подключения
        kubectl exec $MONGO_POD -- mongosh --eval "db.adminCommand('ping')" && echo "✅ MongoDB is responsive"
        
        # Проверяем базу данных todo
        echo "Checking todo database..."
        kubectl exec $MONGO_POD -- mongosh todo --eval "db.getCollectionNames()" || echo "Database might not exist yet"


    - name: Test All API Endpoints
      run: |
        echo "=== Comprehensive API Testing ==="
        
        # Get URL
        URL=$(minikube service todo-app-service --url | head -1)
        
        # 1. Test GET /todos (empty at first)
        echo "1. Testing GET /todos (should return empty array or existing):"
        curl -s "$URL/todos" && echo ""
        
        # 2. Test POST /todos
        echo "2. Testing POST /todos (create new task):"
        CREATE_RESPONSE=$(curl -s -X POST "$URL/todos" \
          -H "Content-Type: application/json" \
          -d '{"text":"Test task 1", "done":false}')
        echo "Created: $CREATE_RESPONSE"
        
        # Extract ID
        TASK_ID=$(echo $CREATE_RESPONSE | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$TASK_ID" ]; then
          echo "ERROR: Could not extract task ID"
          exit 1
        fi
        
        echo "Task ID: $TASK_ID"
        
        # 3. Test GET /todos (should have 1 task now)
        echo "3. Testing GET /todos (should have 1 task):"
        curl -s "$URL/todos"
        echo ""
        
        # 4. Test GET /todos/:id
        echo "4. Testing GET /todos/$TASK_ID:"
        curl -s "$URL/todos/$TASK_ID"
        echo ""
        
        # 5. Test PUT /todos/:id
        echo "5. Testing PUT /todos/$TASK_ID (update):"
        curl -s -X PUT "$URL/todos/$TASK_ID" \
          -H "Content-Type: application/json" \
          -d '{"text":"Updated task", "done":true}'
        echo ""
        
        # 6. Verify update
        echo "6. Verify update (GET /todos/$TASK_ID):"
        curl -s "$URL/todos/$TASK_ID"
        echo ""
        
        # 7. Test DELETE /todos/:id
        echo "7. Testing DELETE /todos/$TASK_ID:"
        curl -s -X DELETE "$URL/todos/$TASK_ID"
        echo "Deleted (should return 204)"
        
        # 8. Verify deletion
        echo "8. Verify deletion (GET /todos should be empty):"
        curl -s "$URL/todos"
        echo ""
        
        echo "✅ ALL 5 ENDPOINTS TESTED SUCCESSFULLY!"



        - name: Verify Data Persistence in MongoDB
          run: |
            echo "=== MongoDB Data Persistence Test ==="
            
            # Get MongoDB pod
            MONGO_POD=$(kubectl get pods -l app=mongodb -o jsonpath='{.items[0].metadata.name}')
            
            # Test 1: Create data via API
            URL=$(minikube service todo-app-service --url | head -1)
            
            echo "1. Creating test data via API..."
            curl -s -X POST "$URL/todos" \
              -H "Content-Type: application/json" \
              -d '{"text":"MongoDB test task", "done":false}'
            
            sleep 5  # Wait for data to be saved
            
            # Test 2: Check data directly in MongoDB
            echo ""
            echo "2. Checking data directly in MongoDB..."
            kubectl exec $MONGO_POD -- mongosh todo --eval "
              print('Collections:');
              db.getCollectionNames();
              print('\\nTasks in todos collection:');
              db.todos.find().pretty();
            "
            
            # Test 3: Restart application pod and verify data persists
            echo ""
            echo "3. Testing data persistence after pod restart..."
            
            # Get app pod
            APP_POD=$(kubectl get pods -l app=todo-app -o jsonpath='{.items[0].metadata.name}')
            echo "Restarting pod: $APP_POD"
            
            # Delete pod (Kubernetes will recreate it)
            kubectl delete pod $APP_POD
            
            echo "Waiting for pod to restart..."
            sleep 30
            
            # Check data is still there
            echo "Checking data after restart..."
            curl -s "$URL/todos" | grep "MongoDB test task" && \
              echo "✅ Data persisted after pod restart!" || \
              echo "❌ Data lost after restart"

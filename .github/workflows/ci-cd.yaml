name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    # 1. Логин в Docker Hub
    - name: Log in to Docker Hub
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    # 2. Сборка и пуш Docker образа
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/todo-app:latest
    
    # 3. Установка Minikube и kubectl
    - name: Install Minikube and kubectl
      run: |
        echo "=== Installing kubectl ==="
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        echo "=== Installing Minikube ==="
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        
        echo "=== Starting Minikube ==="
        minikube start --driver=docker --cpus=2 --memory=4096
        
        echo "=== Minikube status ==="
        minikube status
    
    # 4. Создание Docker Registry Secret
    - name: Create Docker Registry Secret
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "=== Creating Docker Hub secret ==="
        
        # Удаляем если существует
        kubectl delete secret docker-hub-secret --ignore-not-found
        
        # Создаем новый
        kubectl create secret docker-registry docker-hub-secret \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username=$DOCKER_USER \
          --docker-password=$DOCKER_PASS \
          --docker-email=ci-cd@example.com
        
        echo "✅ Docker secret created"
    
    # 5. Деплой MongoDB
    - name: Deploy MongoDB
      run: |
        echo "=== Deploying MongoDB ==="
        
        # Создаем манифесты если их нет
        if [ ! -d "k8s" ]; then
          mkdir k8s
        fi
        
        # MongoDB Deployment
        cat > k8s/mongo-deployment.yaml <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: mongodb-deployment
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: mongodb
          template:
            metadata:
              labels:
                app: mongodb
            spec:
              containers:
              - name: mongodb
                image: mongo:latest
                ports:
                - containerPort: 27017
                env:
                - name: MONGO_INITDB_DATABASE
                  value: todo
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "250m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
        EOF
        
        # MongoDB Service
        cat > k8s/mongo-service.yaml <<EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: mongodb-service
        spec:
          selector:
            app: mongodb
          ports:
            - protocol: TCP
              port: 27017
              targetPort: 27017
        EOF
        
        kubectl apply -f k8s/mongo-deployment.yaml
        kubectl apply -f k8s/mongo-service.yaml
        
        echo "Waiting for MongoDB to start..."
        sleep 30
        
        echo "MongoDB pods:"
        kubectl get pods -l app=mongodb
    
    # 6. Деплой приложения
    - name: Deploy Application
      run: |
        echo "=== Deploying application ==="
        
        # Создаем Deployment
        cat > k8s/deployment.yaml <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: todo-app-deployment
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: todo-app
          template:
            metadata:
              labels:
                app: todo-app
            spec:
              imagePullSecrets:
                - name: docker-hub-secret
              containers:
              - name: todo-app
                image: ${{ secrets.DOCKER_USERNAME }}/todo-app:latest
                ports:
                - containerPort: 3000
                env:
                - name: MONGODB_URI
                  value: "mongodb://mongodb-service:27017/todo"
                - name: PORT
                  value: "3000"
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "100m"
                  limits:
                    memory: "256Mi"
                    cpu: "200m"
                readinessProbe:
                  httpGet:
                    path: /todos
                    port: 3000
                  initialDelaySeconds: 10
                  periodSeconds: 5
                livenessProbe:
                  httpGet:
                    path: /todos
                    port: 3000
                  initialDelaySeconds: 20
                  periodSeconds: 10
        EOF
        
        # Создаем Service
        cat > k8s/service.yaml <<EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: todo-app-service
        spec:
          selector:
            app: todo-app
          ports:
            - protocol: TCP
              port: 80
              targetPort: 3000
          type: NodePort
        EOF
        
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        
        echo "Waiting for application to start..."
        sleep 45
        
        echo "Application pods:"
        kubectl get pods -l app=todo-app
        
        echo "Services:"
        kubectl get svc
    
    # 7. Тестирование приложения
    - name: Test Application
      run: |
        echo "=== Testing application ==="
        
        # Ждем пока под станет ready
        echo "Waiting for pod to be ready..."
        kubectl wait --for=condition=ready pod -l app=todo-app --timeout=120s
        
        # Получаем URL
        echo "Getting application URL..."
        minikube service todo-app-service --url &
        sleep 10
        
        # Используем port-forward для надежности
        echo "Setting up port-forward..."
        kubectl port-forward svc/todo-app-service 8080:80 &
        PF_PID=$!
        sleep 10
        
        # Тестируем endpoints
        echo "=== Testing API Endpoints ==="
        
        # 1. GET /todos
        echo "1. Testing GET /todos:"
        curl -s http://localhost:8080/todos || curl -s http://localhost:8080/todos
        echo ""
        
        # 2. POST /todos
        echo "2. Testing POST /todos:"
        CREATE_RESPONSE=$(curl -s -X POST http://localhost:8080/todos \
          -H "Content-Type: application/json" \
          -d '{"text":"CI/CD Test Task", "done":false}')
        echo "Response: $CREATE_RESPONSE"
        
        # Извлекаем ID из JSON ответа
        TASK_ID=$(echo $CREATE_RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin).get('id', ''))" 2>/dev/null || \
                  echo $CREATE_RESPONSE | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$TASK_ID" ]; then
          TASK_ID=$(echo $CREATE_RESPONSE | grep -o '[a-f0-9]\{24\}')
        fi
        
        echo "Extracted Task ID: $TASK_ID"
        
        if [ -z "$TASK_ID" ]; then
          echo "WARNING: Could not extract task ID, but continuing tests..."
          TASK_ID="test123"  # Заглушка для продолжения тестов
        fi
        
        # 3. Проверяем создание
        echo "3. Verifying task creation:"
        curl -s http://localhost:8080/todos
        echo ""
        
        # 4. GET конкретной задачи
        echo "4. Testing GET /todos/$TASK_ID:"
        curl -s http://localhost:8080/todos/$TASK_ID
        echo ""
        
        # 5. Обновление задачи
        echo "5. Testing PUT /todos/$TASK_ID:"
        curl -s -X PUT http://localhost:8080/todos/$TASK_ID \
          -H "Content-Type: application/json" \
          -d '{"text":"Updated Task", "done":true}'
        echo ""
        
        # 6. Удаление задачи
        echo "6. Testing DELETE /todos/$TASK_ID:"
        curl -s -X DELETE http://localhost:8080/todos/$TASK_ID
        echo ""
        
        # 7. Проверяем удаление
        echo "7. Final verification:"
        curl -s http://localhost:8080/todos
        echo ""
        
        kill $PF_PID
        echo "✅ API tests completed!"
    
    # 8. Проверка MongoDB
    - name: Verify MongoDB
      run: |
        echo "=== Verifying MongoDB ==="
        
        # Ждем готовности MongoDB
        kubectl wait --for=condition=ready pod -l app=mongodb --timeout=60s
        
        MONGO_POD=$(kubectl get pods -l app=mongodb -o jsonpath='{.items[0].metadata.name}')
        
        echo "Testing MongoDB connection..."
        kubectl exec $MONGO_POD -- mongosh --eval "db.adminCommand('ping')" && echo "✅ MongoDB is responsive"
        
        echo "Checking databases..."
        kubectl exec $MONGO_POD -- mongosh --eval "show dbs"
        
        echo "Checking todo database collections..."
        kubectl exec $MONGO_POD -- mongosh todo --eval "db.getCollectionNames()"
